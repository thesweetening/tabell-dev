# üèí SHL Tabellsimulator - Komplett Teknisk Dokumentation

## Projektm√•l & Anv√§ndarupplevelse
Interaktiv simulator d√§r anv√§ndare kan fylla i resultat f√∂r kommande SHL-matcher och se realtidsuppdatering av tabellen. Anv√§ndare t√§nker: *"Vad h√§nder i tabellen om mitt lag vinner och R√∂gle f√∂rlorar?"*

---

## üóÑÔ∏è AIRTABLE DATASTRUKTUR

### Base Information
- **Airtable Base:** SHL-data (exakt Base ID finns i konfiguration)
- **API Access:** Bearer token f√∂r autentisering
- **Paginering:** Kr√§vs f√∂r Matches (289 records > 100 limit)

### Tabell 1: `Teams` (14 lag)
```javascript
// F√§lt struktur:
{
  id: "rec123...",
  fields: {
    "Lag": "Fr√∂lunda HC",           // Lagnamn
    "Stad": "G√∂teborg",             // Hemmastad  
    "F√§rg": "#FF0000",              // Prim√§rf√§rg
    // Andra metadata...
  }
}
```

### Tabell 2: `Team_Stats` (s√§songsstatistik)
```javascript
// KRITISK f√§ltmappning:
{
  id: "rec456...", 
  fields: {
    "Teams": ["recTeamId123"],               // Link till Teams-tabell
    "name (from Teams)": ["Fr√∂lunda HC"],   // Computed field fr√•n Teams
    "games": 15,                             // Spelade matcher
    "wins": 12,                              // Vinster ordinarie  
    "overtime_wins": 0,                      // Vinster √∂vertid/SO
    "losses": 2,                             // F√∂rluster ordinarie
    "overtime_losses": 1,                    // F√∂rluster √∂vertid/SO  
    "goals_for": 49,                         // Gjorda m√•l
    "goals_against": 19,                     // Insl√§ppta m√•l
    "goal_difference": 30,                   // M√•lskillnad (+/-)
    "points": 36,                            // Totala po√§ng
    "season": "2024/25"                      // S√§song
  }
}
```

### Tabell 3: `Matches` (289 matcher)
```javascript
// Matchdata struktur:
{
  id: "rec789...",
  fields: {
    "home_team": "Fr√∂lunda HC",         // Hemmalag
    "away_team": "R√∂gle BK",           // Bortalag  
    "match_date": "2025-10-28",        // Datum
    "home_score": null,                // Hemmaresultat (null = ej spelad)
    "away_score": null,                // Bortaresultat (null = ej spelad)
    "overtime": false,                 // √ñvertid/Straffar boolean
    "finished": false,                 // Match avslutad boolean
    "round": 7                         // Omg√•ng nummer
  }
}
```

---

## üîó API-KOPPLINGAR OCH FALLBACK-SYSTEM

### Prim√§r Backend: Node.js (server.js)
```javascript
// Endpoint: /api/team-stats  
app.get('/api/team-stats', async (req, res) => {
  // H√§mtar fr√•n Airtable Team_Stats
  // Returnerar: {success: true, data: [...]}
});

// Endpoint: /api/matches
app.get('/api/matches', async (req, res) => {
  // Paginering f√∂r 289 matcher:
  let allRecords = [];
  let offset = '';
  do {
    const batch = await airtable.get(`?offset=${offset}&maxRecords=100`);
    allRecords = allRecords.concat(batch.records);
    offset = batch.offset;
  } while (offset);
});
```

### Fallback System: PHP (api-matches.php)
```php
// Backup n√§r Node.js inte tillg√§nglig
$response = file_get_contents("https://api.airtable.com/v0/{$baseId}/Matches", [
  'http' => [
    'header' => "Authorization: Bearer {$apiKey}"
  ]
]);
return json_encode(['success' => true, 'data' => $data]);
```

### Frontend API Requests (shl-simulator-backend.js)
```javascript
async apiRequest(endpoint) {
  // 1. F√∂rs√∂k PHP fallback f√∂rst (f√∂r matches)
  if (endpoint === 'matches') {
    const phpResponse = await fetch('api-matches.php');
  }
  
  // 2. Direktaccess till Airtable med paginering  
  if (this.CONFIG?.airtable?.apiKey) {
    let allRecords = [];
    let offset = '';
    do {
      const url = `https://api.airtable.com/v0/${baseId}/${table}?offset=${offset}`;
      const batch = await fetch(url, {
        headers: { 'Authorization': `Bearer ${apiKey}` }
      });
      allRecords = allRecords.concat(batch.records);
      offset = batch.offset;
    } while (offset);
  }
  
  // 3. Fallback till demo-data
  return this.getDemoData(endpoint);
}
```

---

## ‚öôÔ∏è KONFIGURATIONSHANTERING

### Backend Konfiguration (.env)
```bash
# Airtable credentials
AIRTABLE_API_KEY=keyXXXXXXXXXXXXXX
AIRTABLE_BASE_ID=appXXXXXXXXXXXXXX

# Google OAuth
GOOGLE_CLIENT_ID=xxx.apps.googleusercontent.com  
GOOGLE_CLIENT_SECRET=GOCSPX-xxxxxxxxxxxxxx

# Server
PORT=3000
```

### Frontend Config Loading
```javascript
async loadConfig() {
  try {
    // F√∂rs√∂k ladda fr√•n backend
    const response = await fetch(`${this.API_BASE_URL}/api/config`);
    this.CONFIG = await response.json();
  } catch (error) {
    // Fallback till localStorage om backend otillg√§nglig
    const saved = localStorage.getItem('airtable_config');
    this.CONFIG = saved ? JSON.parse(saved) : { airtable: { apiKey: 'demo_mode' }};
  }
}
```

---

## üéÆ SIMULATOR LOGIK & DATAFL√ñDE

### Nuvarande Kloning-Arkitektur
```javascript
class SHLSimulator {
  constructor() {
    // IMMUTABLE originaldata fr√•n Airtable
    this.originalTeamStats = [];  // R√ñR ALDRIG DENNA!
    
    // MUTABLE arbetskopia f√∂r simulering
    this.currentTeamStats = [];   // Klona fr√•n original
    
    // √ñvrig data
    this.teams = [];              // Lagnamn fr√•n Teams-tabell
    this.matches = [];            // 289 matcher fr√•n Matches-tabell
  }
  
  // KRITISK: Initial dataladdning
  async loadTeamStatsData() {
    const response = await this.apiRequest('team-stats');
    
    // Spara ORIGINAL (r√∂r aldrig)
    this.originalTeamStats = response.data.map(record => {
      // KRITISK namn-mappning fr√•n Airtable
      let teamName = 'Ok√§nt lag';
      if (record.fields["name (from Teams)"]) {
        teamName = Array.isArray(record.fields["name (from Teams)"]) 
          ? record.fields["name (from Teams)"][0]
          : record.fields["name (from Teams)"];
      }
      
      return {
        id: record.id,
        teamId: record.fields.Teams?.[0],
        name: teamName,                    // KRITISKT f√∂r simulator
        games: Number(record.fields.games) || 0,
        wins: Number(record.fields.wins) || 0,
        overtime_wins: Number(record.fields.overtime_wins) || 0,
        losses: Number(record.fields.losses) || 0, 
        overtime_losses: Number(record.fields.overtime_losses) || 0,
        goals_for: Number(record.fields.goals_for) || 0,
        goals_against: Number(record.fields.goals_against) || 0,
        goal_difference: Number(record.fields.goal_difference) || 0,
        points: Number(record.fields.points) || 0  // KRITISKT f√∂r simulator
      };
    });
    
    // Klona f√∂r arbetskopia
    this.cloneOriginalData();
  }
}
```

### Simulering Workflow
```javascript
// 1. USER INPUT ‚Üí handleScoreInput()
handleScoreInput(inputElement) {
  const homeScore = parseInt(homeInput.value);
  const awayScore = parseInt(awayInput.value);
  
  if (homeScore !== null && awayScore !== null) {
    // 2. FRESH START ‚Üí cloneOriginalData()
    this.cloneOriginalData();
    
    // 3. ADD POINTS ‚Üí addPointsToTeam()  
    if (homeScore > awayScore) {
      this.addPointsToTeam(homeTeam, 3, 'ordinarie vinst');
    }
    
    // 4. RENDER ‚Üí renderTableFromCurrentData()
    this.renderTableFromCurrentData();
  }
}

// KLONING: Fr√§sch kopia varje g√•ng
cloneOriginalData() {
  this.currentTeamStats = this.originalTeamStats.map(team => ({
    ...team,  // Kopiera alla egenskaper
    // S√§kerst√§ll numeriska v√§rden
    points: Number(team.points) || 0
  }));
}

// PO√ÑNG: L√§gg till p√• arbetskopia
addPointsToTeam(teamName, points) {
  const team = this.currentTeamStats.find(t => t.name === teamName);
  team.points += points;
  
  // Uppdatera vinster f√∂r sortering
  if (points === 3) team.wins += 1;
  else if (points === 2) team.overtime_wins += 1;
}
```

---

## üé® CSS LAYOUT & PROPORTIONER

### Grid Layout (css/simulator.css)
```css
.simulator-container {
  display: grid;
  grid-template-columns: 1fr 320px;  /* SHL-tabell bred, matchlista 320px */
  gap: 20px;
  max-width: 1400px;
  margin: 0 auto;
}

.shl-table-container {
  /* V√§nster kolumn - tar upp resterande plats */
  background: white;
  border-radius: 8px;
  overflow: hidden;
}

.matches-container {  
  /* H√∂ger kolumn - fast 320px bredd */
  background: #e3f2fd;
  padding: 20px;
  border-radius: 8px;
}
```

### Tabellstyling
```css
.shl-table {
  width: 100%;
  border-collapse: collapse;
  font-family: 'Roboto', sans-serif;
}

.shl-table th {
  background: #dc2626;  /* SHL r√∂d */
  color: white;
  padding: 12px 8px;
  text-align: center;
}

.shl-table td:last-child {
  background: #dc2626;  /* Po√§ng-kolumn r√∂d */
  color: white;
  font-weight: bold;
}
```

---

## üìä SHL PO√ÑNGSYSTEM & SORTERING

### Po√§ngregler (officiella SHL)
```javascript
// Ordinarie tid (60 min)
if (homeScore > awayScore && resultType === 'regular') {
  homeTeam.points += 3;  // Vinnare f√•r 3p
  awayTeam.points += 0;  // F√∂rlorare f√•r 0p
}

// √ñvertid/Straffl√§ggning  
if (homeScore > awayScore && resultType !== 'regular') {
  homeTeam.points += 2;  // Vinnare f√•r 2p
  awayTeam.points += 1;  // F√∂rlorare f√•r 1p (tr√∂stpo√§ng)
}
```

### Tabellsortering (officiell SHL-ordning)
```javascript
sortedStats.sort((a, b) => {
  // 1. Po√§ng (h√∂gst f√∂rst)
  if (b.points !== a.points) return b.points - a.points;
  
  // 2. M√•lskillnad (b√§st f√∂rst)  
  if (b.goal_difference !== a.goal_difference) 
    return b.goal_difference - a.goal_difference;
    
  // 3. Gjorda m√•l (flest f√∂rst)
  if (b.goals_for !== a.goals_for) 
    return b.goals_for - a.goals_for;
    
  // 4. Alfabetisk som sista utv√§g
  return a.name.localeCompare(b.name);
});
```

---

## üöÄ DEPLOYMENT & INFRASTRUKTUR

### GitHub Actions Workflow (.github/workflows/)
```yaml
# Staging deployment (tabell-dev)
name: Deploy to Staging
on:
  push:
    branches: [main]
    
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: FTP Deploy
        uses: SamKirkland/FTP-deploy-action@4.0.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}  
          password: ${{ secrets.FTP_PASSWORD }}
```

### Milj√∂er
- **Staging:** `https://tabell.top/shl-simulator` (tabell-dev repo)
- **Production:** `https://tabell.top/` (tabell-live repo) 
- **Backend:** Node.js p√• port 3000 med PM2
- **Database:** Airtable Cloud

---

## ‚ùå HISTORISKA PROBLEM & L√ñSNINGSF√ñRS√ñK

### Problem 1: Lagnamn undefined
```javascript
// SYMPTOM: console.log ‚Üí "rec123: undefined"
// ORSAK: Fel Airtable-f√§ltmappning
// L√ñSNING: Korrekt mappning av "name (from Teams)"

// F√ñRE (fel):
name: record.fields.name 

// EFTER (r√§tt):  
name: record.fields["name (from Teams)"][0]
```

### Problem 2: Duplicerade po√§ng
```javascript  
// SYMPTOM: 18p ‚Üí 21p ‚Üí 24p ‚Üí 27p vid samma input
// ORSAK: handleScoreInput anropas flera g√•nger
// L√ñSNING: Kloning-system (fresh start varje g√•ng)

// F√ñRE (fel):
team.points += 3; // Adderar p√• tidigare v√§rde

// EFTER (r√§tt):
this.cloneOriginalData(); // Fresh start
team.points += 3; // Adderar p√• original
```

### Problem 3: Fel vinnare
```javascript
// SYMPTOM: R√∂gle 1-3 Fr√∂lunda ‚Üí R√∂gle f√•r po√§ng
// ORSAK: awayScore var null trots input "3"
// L√ñSNING: B√§ttre score-parsing

// F√ñRE (fel):
const score = input.value ? parseInt(input.value) : null;

// EFTER (r√§tt):
const score = input.value !== '' ? parseInt(input.value) : null;
```

---

## üîß NUVARANDE STATUS & AKUT PROBLEM

### Senaste Implementation: Kloning-systemet
- ‚úÖ **Arkitektur:** originalTeamStats (immutable) + currentTeamStats (mutable)
- ‚úÖ **Workflow:** Clone ‚Üí Add Points ‚Üí Render
- ‚ùå **Problem:** Tom tabell efter implementation

### Debug Status (senaste commit)
```javascript
// Senaste debug-meddelanden:
üìä DATA STATUS: {originalTeamStats: ?, currentTeamStats: ?, teamStats: ?}
‚úÖ ORIGINAL TEAM STATS sparad: X lag  
‚úÖ CURRENT TEAM STATS klonad f√∂r simulering
```

### Troliga Orsaker till Tom Tabell
1. **Initial setup:** `originalTeamStats` fylls aldrig
2. **Timing:** `renderTable` k√∂rs innan data laddats  
3. **Reference:** `renderTable` letar i fel data-array
4. **Airtable:** API-anrop misslyckas tyst

---

## üß™ TIDIGARE L√ñSNINGSF√ñRS√ñK

### F√∂rs√∂k 1: Komplex recalculateAllStats
**Approach:** Spara original ‚Üí r√§kna om ALLT fr√•n scratch ‚Üí sortera  
**Problem:** Aldrig anropad, komplex debug-loop  
**Resultat:** Ingen simulering alls

### F√∂rs√∂k 2: Direkt po√§ngaddition  
**Approach:** Hitta lag direkt ‚Üí l√§gg till po√§ng ‚Üí rendera  
**Problem 1:** Duplicerade anrop (18p‚Üí21p‚Üí24p‚Üí27p)  
**Problem 2:** Fel lagnamn (awayScore = null)  
**Problem 3:** Fel vinnare (R√∂gle fick po√§ng ist√§llet f√∂r Fr√∂lunda)  

### F√∂rs√∂k 3: F√∂rb√§ttringar
**Approach:** Duplicate prevention med Set, b√§ttre score-parsing, kr√§va b√•da scores  
**Resultat:** Ingenting h√§nder alls (blockering)

### F√∂rs√∂k 4: Kloning-systemet (NUVARANDE)
**Approach:** originalTeamStats (immutable) + currentTeamStats (mutable)  
**Status:** Implementerat men ger tom tabell  
**N√§sta:** Debug initial setup

---

## üéØ BRAINSTORMING ALTERNATIV

Vid design av kloning-systemet √∂verv√§gdes dessa alternativ:

1. üìã **Klona tabellen** (VALD) - kopiera originaldata f√∂r simulering
2. üéØ **Event-driven system** - lyssna p√• alla √§ndringar
3. üîÑ **React-liknande state management** - centraliserad state
4. üìä **Direkt DOM-manipulation** - uppdatera DOM direkt
5. üßÆ **Funktionell approach** - ren funktionell ber√§kning

Kloning valdes f√∂r dess enkelhet och f√∂ruts√§gbarhet.

---

## üìã N√ÑSTA STEG & PRIORITERINGAR

### Akut (Tom tabell)
1. üîç **Debug initial data loading** - varf√∂r fylls inte originalTeamStats?
2. üîß **Fixa renderTable data-referens** - pekar den p√• r√§tt array?
3. ‚úÖ **Testa basic rendering** - fungerar tabellen utan simulering?

### Core Funktionalitet 
1. üèí **√ñrebro HK test** - 18p + 3p = 21p grundfunktion
2. üîÑ **Reset-funktionalitet** - √•terst√§ll till original
3. üéØ **Multi-match simulering** - flera matcher samtidigt

### Kvalitetss√§kring
1. üìä **Korrekt SHL-po√§ngber√§kning** - f√∂lj officiella regler
2. üèÜ **Tabellsortering** - po√§ng ‚Üí m√•lskillnad ‚Üí gjorda m√•l
3. üé® **Layout proportioner** - SHL-tabell bred, matchlista smal (1fr 320px)

---

## üìÅ FILSTRUKTUR

```
/Volumes/home/Kodning/SHL-V2/
‚îú‚îÄ‚îÄ js/
‚îÇ   ‚îî‚îÄ‚îÄ shl-simulator-backend.js     # Huvudlogik (1134+ rader)
‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îî‚îÄ‚îÄ simulator.css                # Layout & styling  
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îî‚îÄ‚îÄ server.js                    # Node.js API server
‚îú‚îÄ‚îÄ api-matches.php                  # PHP fallback
‚îú‚îÄ‚îÄ PROJECT_STATUS.md                # √Ñldre dokumentation
‚îú‚îÄ‚îÄ PROJEKT_DOKUMENTATION.md        # Denna fil
‚îî‚îÄ‚îÄ .github/workflows/              # GitHub Actions deployment
```

---

## üîë KRITISKA TAKEAWAYS

1. **Airtable-mappning √§r k√§nslig** - f√§ltnamn m√•ste vara exakta
2. **Paginering kr√§vs** - 289 matcher > 100 records limit  
3. **Kloning f√∂rhindrar side-effects** - fresh start varje simulering
4. **Fallback-system √§r essentiellt** - PHP backup n√§r Node.js failar
5. **Debug-first approach** - logga ALLT f√∂r att f√∂rst√• datafl√∂det

**Denna dokumentation inneh√•ller ALLT f√∂r att √•terstarta utvecklingen fr√•n vilken punkt som helst!** üöÄ

---

*Senast uppdaterad: 28 oktober 2025*  
*Status: Tom tabell efter kloning-implementation - beh√∂ver debug*