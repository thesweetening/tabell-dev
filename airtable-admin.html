<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHL Airtable Import - Admin Panel</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #1e3a8a;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        
        .section h2 {
            margin-top: 0;
            color: #374151;
        }
        
        .button {
            background: #1e3a8a;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: background 0.3s;
        }
        
        .button:hover {
            background: #1e40af;
        }
        
        .button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .button.danger {
            background: #dc2626;
        }
        
        .button.danger:hover {
            background: #b91c1c;
        }
        
        .log {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        
        .status {
            padding: 10px 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .status.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        
        .status.error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        .status.warning {
            background: #fffbeb;
            color: #92400e;
            border: 1px solid #fed7aa;
        }
        
        .config-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            margin: 5px 0;
            font-family: monospace;
        }
        
        .progress {
            width: 100%;
            height: 20px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: #10b981;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            üèí SHL Airtable Import - Admin Panel
        </h1>
        
        <!-- Konfiguration -->
        <div class="section">
            <h2>üìã Konfiguration</h2>
            <p>Fyll i dina Airtable-uppgifter i .env filen eller h√§r:</p>
            
            <input type="text" id="apiKey" class="config-input" placeholder="Personal Access Token (pat...)" />
            <input type="text" id="baseId" class="config-input" placeholder="Base ID (app...)" />
            
            <button class="button" onclick="saveConfig()">Spara Konfiguration</button>
            <button class="button" onclick="testConnection()">Testa Anslutning</button>
        </div>
        
        <!-- Status -->
        <div class="section">
            <h2>üìä Status</h2>
            <div id="statusArea"></div>
            
            <div class="progress" style="display: none;" id="progressContainer">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>
        
        <!-- Import -->
        <div class="section">
            <h2>üöÄ Import</h2>
            <p>Importera SHL-matcher fr√•n CSV-fil till Airtable:</p>
            
            <button class="button" onclick="startImport()" id="importBtn">Importera Matcher</button>
            <button class="button" onclick="runDebug()" style="background: #f59e0b;">üîç Debug Import</button>
            <button class="button" onclick="testSingle()" style="background: #10b981;">üß™ Testa En Match</button>
            <button class="button danger" onclick="clearLog()">Rensa Log</button>
        </div>
        
        <!-- Log -->
        <div class="section">
            <h2>üìù Import-log</h2>
            <div id="log" class="log">V√§lkommen till SHL Airtable Importer!\nTryck "Testa Anslutning" f√∂r att b√∂rja.\n</div>
        </div>
    </div>

    <script src="airtable-importer.js"></script>
    <script src="debug-import.js"></script>
    <script>
        let isImporting = false;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('log');
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logElement.textContent += `${timestamp} ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function showStatus(message, type) {
            const statusArea = document.getElementById('statusArea');
            statusArea.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function updateProgress(percent, text = '') {
            const container = document.getElementById('progressContainer');
            const bar = document.getElementById('progressBar');
            
            if (percent > 0) {
                container.style.display = 'block';
                bar.style.width = `${percent}%`;
                if (text) log(text);
            } else {
                container.style.display = 'none';
            }
        }
        
        function saveConfig() {
            const apiKey = document.getElementById('apiKey').value;
            const baseId = document.getElementById('baseId').value;
            
            if (!apiKey || !baseId) {
                showStatus('Fyll i b√•de API-nyckel och Base-ID', 'error');
                return;
            }
            
            // I en riktig implementation skulle vi spara detta p√• servern
            localStorage.setItem('airtable_api_key', apiKey);
            localStorage.setItem('airtable_base_id', baseId);
            
            showStatus('Konfiguration sparad lokalt', 'success');
            log('Konfiguration sparad', 'success');
        }
        
        async function testConnection() {
            log('Testar Airtable-anslutning...');
            
            try {
                // Ladda sparade v√§rden om de finns
                const savedApiKey = localStorage.getItem('airtable_api_key');
                const savedBaseId = localStorage.getItem('airtable_base_id');
                
                if (savedApiKey) document.getElementById('apiKey').value = savedApiKey;
                if (savedBaseId) document.getElementById('baseId').value = savedBaseId;
                
                const success = await window.SHLImporter.testAirtableConnection();
                
                if (success) {
                    showStatus('Airtable-anslutning fungerar!', 'success');
                    log('Anslutning OK - redo f√∂r import', 'success');
                } else {
                    showStatus('Airtable-anslutning misslyckades', 'error');
                    log('Kontrollera API-nyckel och Base-ID', 'error');
                }
                
            } catch (error) {
                showStatus('Anslutningstest misslyckades', 'error');
                log(`Fel: ${error.message}`, 'error');
            }
        }
        
        async function startImport() {
            if (isImporting) return;
            
            isImporting = true;
            const importBtn = document.getElementById('importBtn');
            importBtn.disabled = true;
            importBtn.textContent = 'Importerar...';
            
            try {
                log('üöÄ Startar matchimport...', 'info');
                updateProgress(5, 'F√∂rbereder import...');
                
                // S√§tt upp progress tracking med b√§ttre feedback
                const originalLog = console.log;
                let currentProgress = 5;
                
                console.log = function(...args) {
                    const message = args.join(' ');
                    log(message);
                    
                    // B√§ttre progress baserat p√• meddelanden
                    if (message.includes('Konfiguration laddad')) {
                        currentProgress = 15;
                        updateProgress(currentProgress, 'Konfiguration OK ‚úÖ');
                    } else if (message.includes('H√§mtar lag')) {
                        currentProgress = 25;
                        updateProgress(currentProgress, 'H√§mtar lag fr√•n Airtable...');
                    } else if (message.includes('lag h√§mtade')) {
                        currentProgress = 35;
                        updateProgress(currentProgress, 'Lag h√§mtade ‚úÖ');
                    } else if (message.includes('L√§ser matchdata')) {
                        currentProgress = 45;
                        updateProgress(currentProgress, 'L√§ser matchdata fr√•n CSV...');
                    } else if (message.includes('matcher laddade')) {
                        currentProgress = 55;
                        updateProgress(currentProgress, 'Matchdata laddad ‚úÖ');
                    } else if (message.includes('Kontrollerar befintliga')) {
                        currentProgress = 65;
                        updateProgress(currentProgress, 'Kontrollerar befintliga matcher...');
                    } else if (message.includes('nya att importera')) {
                        currentProgress = 70;
                        updateProgress(currentProgress, 'F√∂rbereder batch-import...');
                    } else if (message.includes('Importerar batch')) {
                        const batchMatch = message.match(/batch (\d+)/);
                        if (batchMatch) {
                            const batchNum = parseInt(batchMatch[1]);
                            currentProgress = 70 + (batchNum * 2); // 2% per batch
                            updateProgress(Math.min(currentProgress, 95), `Importerar batch ${batchNum}...`);
                        }
                    } else if (message.includes('Batch importerad')) {
                        updateProgress(currentProgress, `‚úÖ ${message}`);
                    }
                    
                    originalLog.apply(console, args);
                };
                
                const result = await window.SHLImporter.importSHLMatches();
                
                updateProgress(100, 'Import slutf√∂rd!');
                showStatus(`Import slutf√∂rd! ${result.imported} matcher importerade`, 'success');
                log(`Import slutf√∂rd: ${result.imported} matcher, ${result.errors} fel`, 'success');
                
                // √Öterst√§ll console.log
                console.log = originalLog;
                
            } catch (error) {
                showStatus('Import misslyckades', 'error');
                log(`Import fel: ${error.message}`, 'error');
                console.log = originalLog;
            } finally {
                isImporting = false;
                importBtn.disabled = false;
                importBtn.textContent = 'Importera Matcher';
                updateProgress(0);
            }
        }
        
        function clearLog() {
            document.getElementById('log').textContent = 'Log rensad.\n';
        }
        
        async function runDebug() {
            log('üîç Startar detaljerad debug-analys...', 'info');
            
            try {
                // Omdirigera console.log till v√•r log-funktion under debug
                const originalLog = console.log;
                const originalWarn = console.warn;
                const originalError = console.error;
                
                console.log = (...args) => {
                    log(args.join(' '), 'info');
                    originalLog.apply(console, args);
                };
                
                console.warn = (...args) => {
                    log(args.join(' '), 'warning');
                    originalWarn.apply(console, args);
                };
                
                console.error = (...args) => {
                    log(args.join(' '), 'error');
                    originalError.apply(console, args);
                };
                
                const results = await window.debugImportIssues();
                
                // √Öterst√§ll console
                console.log = originalLog;
                console.warn = originalWarn;
                console.error = originalError;
                
                // Extra info direkt till log
                log('üìä Teams fr√•n Airtable: ' + Object.keys(results.teamsFromAirtable).join(', '), 'info');
                log('üìã Teams fr√•n CSV: ' + results.teamsFromCSV.join(', '), 'info');
                
                if (results.conversionTest) {
                    log(`üß™ Konverteringstest - Kan konvertera: ${results.conversionTest.canConvert}`, results.conversionTest.canConvert ? 'success' : 'error');
                    log(`   Home team ID: ${results.conversionTest.homeTeamId}`, 'info');
                    log(`   Away team ID: ${results.conversionTest.awayTeamId}`, 'info');
                }
                
                if (results.missingTeams.length === 0) {
                    showStatus('‚úÖ Debug OK - Alla lag kan mappas!', 'success');
                    log('‚úÖ Alla lagnamn kan mappas korrekt', 'success');
                } else {
                    showStatus(`‚ùå Debug hittade ${results.missingTeams.length} problem`, 'error');
                    log(`‚ùå Saknade lag: ${JSON.stringify(results.missingTeams)}`, 'error');
                }
                
            } catch (error) {
                showStatus('Debug misslyckades', 'error');
                log(`Debug fel: ${error.message}`, 'error');
                log(`Stack trace: ${error.stack}`, 'error');
            }
        }
        
        async function testSingle() {
            log('üß™ Testar att importera en enda match...', 'info');
            
            try {
                // Omdirigera console f√∂r b√§ttre logging
                const originalLog = console.log;
                const originalError = console.error;
                
                console.log = (...args) => {
                    log(args.join(' '), 'info');
                    originalLog.apply(console, args);
                };
                
                console.error = (...args) => {
                    log(args.join(' '), 'error');
                    originalError.apply(console, args);
                };
                
                const success = await window.testSingleMatchImport();
                
                // √Öterst√§ll console
                console.log = originalLog;
                console.error = originalError;
                
                if (success) {
                    showStatus('‚úÖ Test lyckades! Import borde fungera', 'success');
                    log('‚úÖ En test-match skapades i Airtable', 'success');
                    log('üéØ Detta betyder att batch-importen borde fungera ocks√•', 'info');
                } else {
                    showStatus('‚ùå Test misslyckades', 'error');
                    log('‚ùå Kunde inte skapa test-match', 'error');
                }
                
            } catch (error) {
                showStatus('Test misslyckades', 'error');
                log(`Test fel: ${error.message}`, 'error');
                log(`Stack trace: ${error.stack}`, 'error');
            }
        }
        
        // Ladda sparad konfiguration vid sidladdning
        window.addEventListener('load', function() {
            const savedApiKey = localStorage.getItem('airtable_api_key');
            const savedBaseId = localStorage.getItem('airtable_base_id');
            
            if (savedApiKey) document.getElementById('apiKey').value = savedApiKey;
            if (savedBaseId) document.getElementById('baseId').value = savedBaseId;
        });
    </script>
</body>
</html>